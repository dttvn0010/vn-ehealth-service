<component>
   <section>
     <templateId root="2.16.840.1.113883.3.6000.4.13"/>
    <id root="$utils.randomUUID()"/>
     
     <code code="10160-0" 
     	   codeSystem="2.16.840.1.113883.6.1" 
     	   codeSystemName="LOINC" 
     	   displayName="Medications"
     	   />
     	   
     <title>ĐƠN THUỐC</title>
     
     <text>
     	#if($!dsDonThuoc.size() > 0)
     	<table>
     		<thead>
	     		<tr>
	     			<th rowspan="2">Ngày kê đơn</th>
	     			<th rowspan="2">Bác sĩ kê đơn</th>
	     			<th rowspan="2">Số đơn thuốc</th>
	     			<th colspan="7">Danh sách thuốc</th>	     			
	     		</tr>
	     		<tr>
					<th>Tên thuốc</th>
					<th>Đường dùng</th>
					<th>Tần suất</th>
					<th>Liều lượng</th>
					<th>Ngày bắt đầu</th>
					<th>Ngày kết thúc</th>
					<th>Chỉ dẫn</th>
				</tr>
     		</thead>
     		<tbody>
	     		#foreach($donthuoc in $dsDonThuoc)
		     		<tr>
		     			<td rowspan="$!donthuoc.dsDonThuocChiTiet.size()">$!donthuoc.ngayKeDon</td>
		     			<td rowspan="$!donthuoc.dsDonThuocChiTiet.size()">$!donthuoc.bacSiKeDon.ten</td>     			
		     			<td rowspan="$!donthuoc.dsDonThuocChiTiet.size()">$!donthuoc.soDon</td>
		     			
		     			#set($dtct = $!utils.atList($!donthuoc.dsDonThuocChiTiet, 0))
		     			<td>$!dtct.dmThuoc.ten</td>
						<td>$!dtct.dmDuongDungThuoc.ten</td>
	  					<td>$!dtct.dmTanSuatDungThuoc.ten</td>
	  					<td>$!dtct.lieuLuongThuoc.soLuong  $!dtct.lieuLuongThuoc.donVi</td>
	  					<td>$!dtct.ngayBatDau</td>
	  					<td>$!dtct.ngayKetThuc</td>
	  					<td>$!dtct.chiDanDungThuoc</td>
	 				</tr>
	 				#foreach($dtct in $!utils.subList($!donthuoc.dsDonThuocChiTiet, 1))
	   					<tr>
	   						<td>$!dtct.dmThuoc.ten</td>
	   						<td>$!dtct.dmDuongDungThuoc.ten</td>
	   						<td>$!dtct.dmTanSuatDungThuoc.ten</td>
	   						<td>$!dtct.lieuLuongThuoc.soLuong  $!dtct.lieuLuongThuoc.donVi</td>
	   						<td>$!dtct.ngayBatDau</td>
	   						<td>$!dtct.ngayKetThuc</td>
	   						<td>$!dtct.chiDanDungThuoc</td>
	   					</tr>
	  				#end
	     		#end
	     	</tbody>
     	</table>
     	#end
     </text>
     
     #foreach($donthuoc in $dsDonThuoc)
     <entry typeCode="DRIV">
       <act classCode="ACT" moodCode="EVN">
         <templateId root="2.16.840.1.113883.3.6000.5.41"/>
         <id root="$utils.randomUUID()" extension="$!donthuoc.soDon"/>
         
         <code code="432102000" 
         	   codeSystem="2.16.840.1.113883.6.96" 
         	   codeSystemName="SNOMED-CT" 
         	   displayName="Administration of substance"/>
         	   
         <effectiveTime value="$!utils.formatDate($!donthuoc.ngayKeDon)"/>
         
         <performer>
           <assignedEntity>
             <templateId root="2.16.840.1.113883.3.6000.5.11.2"/>
             <id root="$utils.randomUUID()"/>
             
             <code code="405279007" 
             	   codeSystem="2.16.840.1.113883.6.96" 
             	   codeSystemName="SNOMED CT" 
             	   displayName="Attending physician"
             	   />
             
             <assignedPerson>
               <name>$!donthuoc.bacSiKeDon.ten</name>
             </assignedPerson>
           </assignedEntity>
         </performer>
         
         #foreach($dtct in $!donthuoc.dsDonThuocChiTiet)
         <entryRelationship typeCode="COMP">
           <substanceAdministration classCode="SBADM" moodCode="INT">
             <templateId root="2.16.840.1.113883.3.6000.5.42"/>
             <id root="$utils.randomUUID()"/>
             
             #set($dm=$!dtct.dmTanSuatDungThuoc)
             <code code="$!dm.ma"
            	   displayName="$!dm.ten"/>
             
             <effectiveTime xsi:type="IVL_TS">
               <low value="$!utils.formatDate($!dtct.ngayBatDau)"/>
               <high value="$!utils.formatDate($!dtct.ngayKetThuc)"/>
             </effectiveTime>
             
             #set($dm=$!dtct.dmDuongDungThuoc)
             <routeCode code="$!dm.ma"
            			codeSystem="2.16.840.1.113883.3.6000.2.11"
            		 	displayName="$!dm.ten"/>

             #if($!dtct.lieuLuongThuoc.soLuong)
             <doseQuantity value="$!dtct.lieuLuongThuoc.soLuong" unit="$!dtct.lieuLuongThuoc.donVi"/>
             #end
             
             <consumable>
               <manufacturedProduct>
                 <templateId root="2.16.840.1.113883.3.6000.5.43"/>
                 
                 <manufacturedMaterial>

                 	#set($dm=$!dtct.dmThuoc)
             		<code code="$!dm.ma"
           				  codeSystem="2.16.840.1.113883.3.6000.1.15"
           		 		  displayName="$!dm.ten">
           		 			<originalText>$!dtct.bietDuoc</originalText>
           		 	</code>
           		 	                 	
                 </manufacturedMaterial>
               </manufacturedProduct>
             </consumable>
             
             <entryRelationship typeCode="COMP">
               <act classCode="ACT" moodCode="INT">
                 <templateId root="2.16.840.1.113883.3.6000.5.44"/>
                 <id root="$utils.randomUUID()"/>
                 
                 <code code="69730-0" 
                 	   codeSystem="2.16.840.1.113883.6.1" 
                 	   codeSystemName="LOINC" 
                 	   displayName="Instructions"/>
                 	   
                 $!utils.createText($!dtct.chiDanDungThuoc)
               </act>
             </entryRelationship>
           </substanceAdministration>
         </entryRelationship>
         #end         
       </act>
     </entry>
     #end     
   </section>
 </component>
     